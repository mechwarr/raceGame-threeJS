<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Race Game — three.js 版本（iframe 內）</title>
  <style>
    html, body { margin:0; height:100%; background:#03060b; color:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans TC',sans-serif; }
    #stage { position:absolute; inset:0; display:grid; place-items:center; }
    canvas { width: min(96vw, 1000px); height: auto; max-height: 90vh; border:1px solid #223; border-radius:12px; background:#000; }
    .paused { filter: grayscale(.5) brightness(.85); }
    .banner { position:fixed; left:8px; top:8px; padding:6px 10px; border-radius:8px; font-size:12px; }
    .ok { background:#0a3; color:#fff; }
    .err{ background:#a00; color:#fff; }
    #log { position:absolute; left:8px; bottom:8px; font-size:12px; opacity:.8; white-space:pre-wrap; max-width:60ch; }
  </style>
</head>
<body>
  <div id="stage">
    <canvas id="three-canvas"></canvas>
  </div>
  <pre id="log"></pre>

  <!-- 使用 CDN 的 ES Module 版本 three.js（無需打包） -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.165.0/build/three.module.js';

    // ====== 小工具 ======
    const $log = document.getElementById('log');
    const log = (...a) => { $log.textContent += a.join(' ') + '\n'; };
    const reportProgress = (v)=> parent?.postMessage({ type:'game:progress', value:v }, '*');
    const reportReady    = ()=> parent?.postMessage({ type:'game:ready' }, '*');
    const reportError    = (e)=> parent?.postMessage({ type:'game:error', error: String(e) }, '*');
    const banner = (msg, ok=true)=>{
      const d = document.createElement('div');
      d.className = 'banner ' + (ok ? 'ok' : 'err');
      d.textContent = msg; document.documentElement.appendChild(d); setTimeout(()=>d.remove(), 3800);
    };

    // ====== 主要 three.js 場景 ======
    /** @type {HTMLCanvasElement} */
    const canvas = document.getElementById('three-canvas');
    let renderer, scene, camera, clock;
    let running = false; // 是否更新賽況
    let disposed = false;

    // "馬" 以方塊代表
    /** @type {THREE.Mesh[]} */
    let horses = [];
    const laneCount = 5;
    const trackLength = 100; // x 方向長度（世界單位）

    function initThree(){
      // Renderer
      renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
      resize();

      // Scene & Camera
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);
      camera = new THREE.PerspectiveCamera(55, canvas.clientWidth / canvas.clientHeight, 0.1, 500);
      camera.position.set(0, 22, 45);
      camera.lookAt(0, 0, 0);

      // Light
      const hemi = new THREE.HemisphereLight(0xffffff, 0x223344, 0.8);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(30, 50, 10);
      scene.add(dir);

      // Track (草地)
      const track = new THREE.Mesh(
        new THREE.PlaneGeometry(trackLength, laneCount * 6, 1, laneCount),
        new THREE.MeshPhongMaterial({ color: 0x0b7a3b })
      );
      track.rotation.x = -Math.PI/2;
      scene.add(track);

      // 跑道白線
      const lineMat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent:true, opacity:0.5 });
      for (let i= -laneCount/2; i<= laneCount/2; i++){
        const geo = new THREE.BufferGeometry().setFromPoints([
          new THREE.Vector3(-trackLength/2, 0.01, i*6),
          new THREE.Vector3(trackLength/2, 0.01, i*6)
        ]);
        const line = new THREE.Line(geo, lineMat);
        scene.add(line);
      }

      // Horses
      const colors = [0xff5555, 0xffaa00, 0x00c8ff, 0xff66cc, 0xdddd33];
      for (let i=0; i<laneCount; i++){
        const body = new THREE.Mesh(
          new THREE.BoxGeometry(2, 1.2, 1.2),
          new THREE.MeshStandardMaterial({ color: colors[i % colors.length] })
        );
        body.position.set(-trackLength/2 + 2, 0.6, (i - (laneCount-1)/2) * 6);
        scene.add(body);
        horses.push(body);
      }

      // 起跑線 & 終點線
      const makeGate = (x, color)=>{
        const g = new THREE.Mesh(new THREE.BoxGeometry(0.4, 4, laneCount*6), new THREE.MeshBasicMaterial({ color }));
        g.position.set(x, 2, 0); scene.add(g);
      };
      makeGate(-trackLength/2, 0x3ab0ff);
      makeGate( trackLength/2, 0xff4081);

      clock = new THREE.Clock();
      animate();
    }

    function resize(){
      const w = Math.min(window.innerWidth * 0.96, 1000);
      const h = Math.min(window.innerHeight * 0.9, 1000 / (16/9));
      renderer?.setSize(w, h, false);
      camera && (camera.aspect = w/h, camera.updateProjectionMatrix());
    }
    window.addEventListener('resize', resize);

    // 基礎比賽邏輯：每匹馬有不同隨機速度 + 微幅擺動（當作奔跑動畫）
    const baseSpeeds = Array.from({length: laneCount}, ()=> 6 + Math.random()*2); // 單位/秒
    const noise = (t, i)=> Math.sin(t*5 + i*1.3) * 0.3;

    function animate(){
      if (disposed) return; // 被釋放
      requestAnimationFrame(animate);
      const dt = clock.getDelta();

      // 暫停時也保持畫面可重新繪製（但不更新位置）
      if (running){
        for (let i=0; i<horses.length; i++){
          const h = horses[i];
          h.position.x += baseSpeeds[i] * dt; // 往 +x 跑
          h.position.y = 0.6 + Math.abs(noise(clock.elapsedTime, i))*0.2; // 上下起伏
        }
      }

      // 畫面邊界循環（示範）
      for (const h of horses){
        if (h.position.x > trackLength/2 - 2){ h.position.x = -trackLength/2 + 2; }
      }

      renderer.render(scene, camera);
      canvas.classList.toggle('paused', !running);
    }

    // ====== 和宿主溝通（postMessage） ======
    function onGameStart(){ running = true; log('[Game] Start'); }
    function onGamePause(){ running = false; log('[Game] Pause'); }
    function onGameEnd(){
      log('[Game] End & dispose');
      running = false; disposed = true;
      window.removeEventListener('message', onMsg);
      window.removeEventListener('resize', resize);
      if (renderer){ renderer.dispose(); renderer.forceContextLoss?.(); }
    }

    function onMsg(ev){
      const msg = ev.data;
      if (!msg || typeof msg !== 'object') return;
      switch (msg.type){
        case 'host:start': onGameStart(); break;
        case 'host:pause': onGamePause(); break;
        case 'host:end':   onGameEnd();   break;
      }
    }
    window.addEventListener('message', onMsg);

    // ====== 啟動 ======
    (async function boot(){
      try{
        reportProgress(5);
        initThree();
        reportProgress(60);
        // 這裡如果要載入模型/材質，可以逐步回報 60→90
        // 本示例皆為程式產生，直接結束
        reportProgress(100);
        reportReady();
        banner('three.js CDN 初始化完成', true);
        log('[Boot] three.js ready');
      }catch(e){
        reportError(e); banner('初始化失敗', false); log('[Boot Error]', e);
        if (location.protocol === 'file:'){
          log('提示：請改用本機 HTTP 伺服器（例如 `npx http-server`）。');
        }
      }
    })();
  </script>
</body>
</html>
